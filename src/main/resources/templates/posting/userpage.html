<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>개인페이지</title>
</head>
<style>
    #postTbody {
        display: flex;
        flex-wrap: wrap;
    }
    #postTbody tr {
        display: flex;
        flex-direction: row;
        margin: 10px;
    }
    #postTbody td {
        padding: 5px;
    }
    #postTbody img {
        width: 330px;
        height: auto;
        margin-right: 10px;
    }

    #modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 배경을 반투명 검정으로 설정 */
        z-index: 1000; /* 다른 요소들 위에 표시되도록 설정 */
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        position: relative;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 50%;
        max-width: 500px;
        margin: auto;
    }

    .modal-content img {
        /*width: 100%;*/
        height: auto;
        margin-bottom: 10px;
    }

    .modelBtn {
        padding: 10px 20px;
        background-color: #c1c1c1 ;
        color: ;
        border: none;
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 10px;
        border-radius: 5px;
    }
</style>
<body>
<h1><span th:text="${user.userName}"></span>님의 마이페이지</h1>
<p th:each=" img : ${userImg}">
    <img th:src="${img.prfImgUrl}" alt="프로필 사진" width="100" style="border-radius: 50%; object-fit: cover;">
</p>
<p th:text="${user.userName}"></p>
<p th:text="${user.userEmail}"></p>
<p>게시물</p>
<p th:text="${countPostingCount}">게시물 수</p>
<p><a th:href="@{'/posting/{userId}/follower.do'(userId=${user.userId})}">팔로워</a></p>
<p th:text="${countFolloweeCount}">팔로워 수</p>
<p><a th:href="@{'/posting/{userId}/followee.do'(userId=${user.userId})}">팔로우</a></p>
<p th:text="${countFollowerCount}">팔로우 수</p>

<a th:href="@{'/posting/{userId}/setting.do'(userId=${user.userId})}"><button>설정</button></a>
<a th:href="@{'/inquire/findAll/{userId}.do'(userId=${user.userId})}"><button>고객센터</button></a>

<form action="/search/users.do" method="GET">
    <label for="searchUser">사람 태그</label>
    <input type="text" id="searchUser" name="searchUser" required>
    <button type="submit" id="searchUserBtn">검색</button>
</form>

<div>
    <button id="postingBtn">포스트</button>
    <div>
        <table id="postTable">
            <a th:href="@{'/posting/{userId}/postAdd.do'(userId=${user.userId})}"><button id="postAddBtn">게시물 추가</button></a>
            <thead>
            <tr>
<!--                <th>이미지</th>-->
<!--                <th>내용</th>-->
<!--                <th>장소태그</th>-->
<!--                <th>사람태그</th>-->
<!--                <th>댓글</th>-->
            </tr>
            </thead>
            <tbody id="postTbody">

            </tbody>
        </table>
    </div>
</div>

<div id="modal" style="display: none;"></div>

</body>

<script>
    const postTbody = document.getElementById("postTbody");
    const USER_ID='[[${user.userId}]]';  // userId가 문자열이기 때문에 ''로 문자열임을 표시!!!
    const modal = document.getElementById("modal")

    const userPost = async function(){
        const url = `/posting/${USER_ID}/postpage.do`; // 백틱으로 사용해야 가능
        const response = await fetch(url);
        const posts = await response.json();
        let html = "";
        // console.log(posts)

        // 이미지를 표시할 때 필요한 변수
        // let postImageMap = {};

        for(let p of posts){
            // console.log("posts 출력",posts)
            // console.log("p 출력",p)
            // console.log(p.postingImages)
            // console.log("postId 출력",p.postId)
            let firstImageObj = p.postingImages.find(img => img.imgOrder === 0);
            let firstImage = firstImageObj && firstImageObj.imgUrl;
            html+=`
                    <tr>
                        <td>
                            <img src="${firstImage}" alt="포스팅 대표 이미지" width="330" class="postimg"  data-post-id="${p.postId}" >
                        </td>
                    </tr>`;

            // html+=`
            //         <tr>
            //             <td>
            //                 <img src="${firstImage}" alt="포스팅 대표 이미지" width="330" class="clickable-image" data-post-id="${p.post_id}">
            //             </td>
            //         </tr>`;

            // 이미지를 post_id 별로 저장
            // postImagesMap[postId] = p.postingImages;
        }



//         for(let p of posts){
//             console.log(p.contents)
//             console.log(p.locationTag)
//             console.log(p.personTagId)
//             //console.log(p.postingImages)
//             //console.log(p.postingComments)
//                 for(let i of p.postingImages){
//                     console.log(i.imgUrl)
//                     for(let c of p.postingComments){
//             html+=`
// <!--                    <tr><a href="/posting/${USER_ID}/postAdd.do"><button id="postAddBtn" >게시물 추가</button></a></tr>-->
//                     <tr>
// <!--                        <td>${i.imgUrl}</td>-->
//                         <td><img src="${i.imgUrl}" alt="포스팅 이미지" width="330"></td>
// <!--                        <td>${p.contents}</td>-->
// <!--                        <td>${p.locationTag}</td>-->
// <!--                        <td>${p.personTagId}</td>-->
// <!--                        <td>${c.contents}</td>-->
//                     </tr>`;
//                     console.log(c.contents)
//                     }
//                 }
//         }
        postTbody.innerHTML=html;
        // let postList = document.getElementById('postList');
        // postList.innerHTML = posts.map('${postings.contents}').join('');
    };
    document.getElementById('postingBtn').addEventListener('click',userPost);
    // const USER_ID=[[${user.userId}]]
    // console.log(USER_ID);

   //  const postingBtn=document.getElementById("postingBtn");
   //  const postTbody=document.getElementById("postTbody");
   //
   //  const postUser=async function(){
   //      let url=/posting/${USER_ID}/postpage.do
   //      let response = await fetch(url);
   //      let data = await response.json();
   //
   //      console.log(data);
   //      let html = "";
   //      for(let postings of data){
   //          html+=            <thead>
   //  <tr>
   //      <th>contents</th>
   //      <th>장소</th>
   //      <th>사람</th>
   //  </tr>
   //  </thead>
   //  <tbody id="postTbody">
   //
   //  </tbody>`
   //      }
   //      postTbody.innerHTML=html;
   //  }
   //
   // postingBtn.addEventListener("click",postUser)


    // 모달
    document.addEventListener("click", async(e)=>{
        const target = e.target.closest('.postimg');
        if (!target) return; // 클릭한 곳에 postimg 클래스 없으면 아무것도 안 함

        const postId = target.dataset.postId;
        if (!postId) return;

        // console.log("e.target 출력", e.target)
        // console.log("e.target.dataset 출력", e.target.dataset)
        // console.log("e.target.dataset.postId 출력", e.target.dataset.postId)
        const url2 = `/posting/${USER_ID}/postdetail.do?postId=${postId}`
        const res = await fetch(url2)
        const detail = await res.json();

        modal.innerHTML = `
            <div class="modal-content">
            <button class="modelBtn" onclick="modal.style.display='none'">닫기</button>
            ${detail.postingImages ? detail.postingImages.map(img => `<img src="${img.imgUrl}" width="100">`).join('') : ''}
<!--            ${detail.comments && detail.comments.length > 0 ? detail.comments.map(com => `<p>${com.content}</p>`).join('') : ''}-->
<!--            <div> ❤️ $ </div>>-->
            <p>${detail.contents}</p>
            <br>
            ${detail.comments ? detail.comments.map(com => `<p>${com.contents}</p>`).join('') : ''}
            </div>
        `;
        modal.style.display = "block";

        console.log("detail:", detail);
        console.log("postingImages:", detail.postingImages);
        console.log("comments:", detail.comments);
    });

    // document.getElementById("modal").innerHTML = `
    //     <div class="modal-content">
    //         <h2>${d.writer}</h2>
    //         <p>${d.content}</p>
    //         ${d.imageUrls.map(u => `<img src="${u}" width="200">`).join('')}
    //         <div>❤️ ${d.likeCount}</div>
    //         ${d.comments.map(c => `<p><b>${c.writer}</b>: ${c.content}</p>`).join('')}
    //         <button onclick="document.getElementById('modal').style.display='none'">닫기</button>
    //     </div>
    // `;
    // document.getElementById("modal").style.display = "block";


</script>

<script th:if="${message}" th:inline="javascript">
    alert([[${message}]]);
</script>

</html>